<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Results - Recipe Translator</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% include '_sidebar.html' %}

    <div class="container results-page">
        <a href="{{ url_for('index') }}" class="back-link">← Back to Home</a>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Recipe Image -->
        {% if recipe.image %}
        <div class="recipe-hero-image">
            <img src="{{ recipe.image }}" alt="{{ recipe.title }}">
        </div>
        {% endif %}

        <!-- Recipe Title & Actions -->
        <div class="recipe-header">
            <h1>{{ recipe.title }}</h1>
            <div class="recipe-actions">
                <button id="saveToLibraryBtn" class="btn btn-primary" style="min-width: 180px;">
                    Save to Library
                </button>
                <button id="copyBtn" class="action-btn" title="Copy recipe">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M8 3C7.44772 3 7 3.44772 7 4V12C7 12.5523 7.44772 13 8 13H16C16.5523 13 17 12.5523 17 12V4C17 3.44772 16.5523 3 16 3H8Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M5 7H4C3.44772 7 3 7.44772 3 8V16C3 16.5523 3.44772 17 4 17H12C12.5523 17 13 16.5523 13 16V15" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Copy
                </button>
                <button id="downloadBtn" class="action-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M10 3V13M10 13L6 9M10 13L14 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M3 17H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Download
                </button>
                <button onclick="window.print()" class="action-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M5 7V3H15V7M5 15H4C3.44772 15 3 14.5523 3 14V9C3 8.44772 3.44772 8 4 8H16C16.5523 8 17 8.44772 17 9V14C17 14.5523 16.5523 15 16 15H15M5 11H15V17H5V11Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Print
                </button>
            </div>
        </div>

        <!-- Recipe Content -->
        <div class="recipe-body">
            <div id="recipeContent" class="recipe-content"></div>
        </div>
    </div>

    <script>
        // Recipe data from backend
        const recipeData = {
            content: {{ recipe.content | tojson | safe }},
            title: {{ recipe.title | tojson | safe }}
        };

        // Convert markdown to HTML (same function as app.js)
        function markdownToHtml(markdown) {
            let html = markdown;

            // Headers
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');

            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Lists - unordered (lines starting with -)
            html = html.replace(/^[-•] (.+)$/gm, '<li>$1</li>');

            // Lists - ordered (lines starting with number.)
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');

            // Wrap consecutive list items
            const lines = html.split('\n');
            let result = [];
            let inList = false;
            let listType = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const nextLine = i < lines.length - 1 ? lines[i + 1] : '';

                if (line.trim().startsWith('<li>')) {
                    if (!inList) {
                        // Determine list type based on original line
                        const originalLine = markdown.split('\n')[i];
                        listType = /^\d+\./.test(originalLine) ? 'ol' : 'ul';
                        result.push(`<${listType}>`);
                        inList = true;
                    }
                    result.push(line);

                    // Close list if next line is not a list item or is empty
                    if (!nextLine.trim().startsWith('<li>') && nextLine.trim() !== '') {
                        result.push(`</${listType}>`);
                        inList = false;
                    }
                } else {
                    if (inList && line.trim() === '') {
                        result.push(`</${listType}>`);
                        inList = false;
                    }
                    result.push(line);
                }
            }

            if (inList) {
                result.push(`</${listType}>`);
            }

            html = result.join('\n');

            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // Clean up
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<p>(\s*<[huo])/g, '$1');
            html = html.replace(/(<\/[huo][^>]*>)\s*<\/p>/g, '$1');

            return html;
        }

        // Display recipe
        document.getElementById('recipeContent').innerHTML = markdownToHtml(recipeData.content);

        // Copy functionality
        async function copyRecipe() {
            try {
                await navigator.clipboard.writeText(recipeData.content);
                showFeedback('Copied!');
            } catch (error) {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = recipeData.content;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showFeedback('Copied!');
                } catch (err) {
                    alert('Failed to copy recipe');
                }
                document.body.removeChild(textArea);
            }
        }

        function showFeedback(message) {
            const btn = document.getElementById('copyBtn');
            const original = btn.innerHTML;
            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 10L9 14L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Copied!';
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = original;
                btn.classList.remove('btn-success');
            }, 2000);
        }

        // Download functionality
        async function downloadRecipe() {
            const filename = recipeData.title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '_')
                .substring(0, 50);

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: recipeData.content,
                        filename: filename
                    })
                });

                if (!response.ok) throw new Error('Failed to download');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + '.md';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Failed to download recipe: ' + error.message);
            }
        }

        // Save to Library functionality
        async function saveToLibrary() {
            const btn = document.getElementById('saveToLibraryBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Saving...';

            try {
                const response = await fetch('/api/recipes/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipeData: {{ recipe | tojson | safe }}
                    })
                });

                const data = await response.json();

                if (data.success) {
                    btn.innerHTML = '✓ Saved!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    setTimeout(() => {
                        window.location.href = '/library';
                    }, 1000);
                } else {
                    alert('Failed to save recipe: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                alert('Error saving recipe: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Event listeners
        document.getElementById('copyBtn').addEventListener('click', copyRecipe);
        document.getElementById('downloadBtn').addEventListener('click', downloadRecipe);
        document.getElementById('saveToLibraryBtn').addEventListener('click', saveToLibrary);
    </script>
</body>
</html>
